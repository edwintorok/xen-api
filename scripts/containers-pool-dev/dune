; this takes a few seconds, so only done upon request
(rule
  ; external dependency, not cachable by dune
  (alias opam-update)
  (deps (universe))
  (action
    (run opam update -R %{env:REPOSITORY=xs-opam}))
)

; generate list of OS packages
; opam monorepo depext would filter out OS packages that are already installed,
; so use plain opam to query
(rule
  (target depext.packages)
  (deps (:lockfile ../../xapi.opam.locked))
  (action
    (with-stdout-to %{target}
     (setenv OPAMVAR_arch x86_64
     (setenv OPAMVAR_os_family centos
     (setenv OPAMVAR_os_distribution centos
     (setenv OPAMVAR_os_version 7
      (run opam show -f depexts %{lockfile}))))))))

; find docker/podman callable from dune
(rule
  (target container_cli)
  (deps dune detect_container_cli.sh)
  (action
    (progn
      (with-stdout-to %{target}
       (progn
         (echo "#/bin/sh\nset -eu\n")
         (run ./detect_container_cli.sh)))
      (run chmod +x %{target}))
    )
  )

; find out the commit hash from a repo
(rule
  ; this takes a few seconds, so only done upon request
  (alias opam-update)
  (target xs-opam.commit)
  (action (with-stdout-to %{target}
                          (system "git ls-remote %{read-lines:xs-opam.url} refs/heads/master | cut -f1"))
))


;(rule
;  (target xapi.opam.locked.depends)
;  (deps xapi.opam.locked)
 ; (action (with-stdout-to %{target} (run opam show -f depends --just-file ./%{deps})))
;)

(rule
  (target xapi.opam.locked.depends.opamprovided)
  (deps xapi.opam.locked.depends)
  (action (with-stdout-to %{target} (run grep -v '?vendor' %{deps})))
)

(rule
  (target xapi.opam.locked.depends.opam.digest)
  (deps xapi.opam.locked.depends.opamprovided)
  (action (with-stdout-to %{target} (run sha256sum %{deps})))
)

(rule
  (target source.version)
  (deps (universe))
  (action (with-stdout-to %{target} (run git describe --dirty)))
)

(rule
  (target Containerfile)
  (deps (:generator cpd_gen_installdeps.exe)
        (:lockfile xapi.opam.locked)
        xapi.opam.locked.depends.opam.digest
        source.version
        depext.packages)
  (action (with-stdout-to %{target}
   (run %{generator}
        --lockfile %{lockfile}
        --opam-deps-id %{read-lines:xapi.opam.locked.depends.opam.digest}
        --repository %{read-lines:xs-opam.url}
        --gitdescribe %{read-lines:source.version}
        %{read-lines:depext.packages}
        )))
  (mode promote)
)


(executables
  (names cpd_gen_installdeps cpd_gen_tools)
  (libraries containergen))

(rule
  (alias docker-build)
  (deps (:containerfile Containerfile) (glob_files *.opam) (universe))
  (action
    (chdir %{project_root}
           (setenv DOCKER_BUILDKIT 1
                   (setenv BUILDKIT_PROGRESS plain
                  (setenv PROGRESS_NO_TRUNC 1
                   (run docker build -t cpd  -f %{containerfile} .))))))
)

(rule
  (alias podman-build)
  (deps (:containerfile Containerfile) (universe))
  (action
    (chdir %{project_root}
                   (run echo podman build -t cpd  -f %{containerfile} .))))
