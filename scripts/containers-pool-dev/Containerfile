# syntax=docker/dockerfile:1
FROM docker.io/ocaml/opam:centos-7-ocaml-4.13 as duniverse
ENV DUNE_CACHE="enabled" DUNE_CACHE_STORAGE_MODE="copy"
RUN mkdir -p /home/opam/.cache/dune/db
RUN --mount=type=cache,target=/home/opam/.cache/dune,sharing=shared,uid=1000,gid=1000 --mount=type=cache,target=/home/opam/.opam/download-cache,sharing=locked,uid=1000,gid=1000 --mount=type=tmpfs,target=/tmp 'opam' 'install' 'opam-monorepo'
RUN 'mkdir' '-p' '/home/opam/workspace'
RUN 'ls' '-ld' '/tmp'
RUN --mount=type=bind,target=/home/opam/workspace/xapi.opam.locked,source=xapi.opam.locked --mount=type=cache,target=/home/opam/.cache/dune,sharing=shared,uid=1000,gid=1000 --mount=type=cache,target=/home/opam/.opam/download-cache,sharing=locked,uid=1000,gid=1000 'opam' 'monorepo' 'pull' '-r' '/home/opam/workspace' '-l' '/home/opam/workspace/xapi.opam.locked' && \
  'true' 'b4371e35ddaaac0edb661a9e7cf1ade6'
# syntax=docker/dockerfile:1
FROM docker.io/ocaml/opam:centos-7-ocaml-4.13
ENV DUNE_CACHE="enabled" DUNE_CACHE_STORAGE_MODE="copy"
RUN mkdir -p /home/opam/.cache/dune/db
RUN --mount=type=cache,target=/var/cache/yum,sharing=locked,uid=0,gid=0 'sudo' 'yum' 'install' '-y' 'epel-release' 'centos-release-xen' && \
  'sudo' 'yum' 'install' '-y' 'autoconf' 'gcc' 'gmp' 'gmp-devel' 'hwdata' 'kernel-headers' 'libffi-devel' 'libnl3' 'libnl3-devel' 'openssl-devel' 'pam-devel' 'pciutils-devel' 'perl-ExtUtils-MakeMaker' 'pkgconfig' 'python2' 'systemd-devel' 'which' 'xen-devel' 'xxhash-devel' 'xxhash-libs'
RUN 'mkdir' '-p' '/home/opam/workspace' '/home/opam/.cache/dune/db/files'
RUN --mount=type=bind,target=/home/opam/workspace/xapi.opam.locked,source=xapi.opam.locked --mount=type=cache,target=/home/opam/.cache/dune,sharing=shared,uid=1000,gid=1000 --mount=type=cache,target=/home/opam/.opam/download-cache,sharing=locked,uid=1000,gid=1000 --mount=type=tmpfs,target=/tmp 'opam' 'repository' 'set-url' 'default' 'https://github.com/edwintorok/xs-opam.git' && \
  'true' '41893d3bb3a50ac0bdda88002c37b6afe8ca11df7366d961476cecc4cdda1365  xapi.opam.locked.depends.opamprovided' && \
  'opam' 'install' '--ignore-pin-depends' '--deps-only' '/home/opam/workspace/xapi.opam.locked' '--locked'
COPY --from=duniverse [ "/home/opam/workspace/duniverse", "/home/opam/workspace/duniverse" ]
RUN --mount=type=bind,target=/home/opam/workspace/source,source=. --mount=type=cache,target=/home/opam/.cache/dune,sharing=shared,uid=1000,gid=1000 --mount=type=cache,target=/home/opam/workspace/_build,id=./_build,sharing=locked,uid=1000,gid=1000 'touch' '/home/opam/workspace/dune-workspace' && \
  'true' 'v22.34.0-114-g128c6e381-dirty' && \
  'cd' '/home/opam/workspace/source' && \
  'opam' 'exec' '--' 'dune' 'build' '--cache' 'enabled' '--cache-storage-mode' 'copy' '--profile=release' 'xapi.install' 'xe.install' 'message-switch-unix.install' 'forkexec.install'
