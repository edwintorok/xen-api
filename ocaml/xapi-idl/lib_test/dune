(data_only_dirs test_data)

(library
  (name test_lib)
  (modules idl_test_common)
  (libraries
    (re_export alcotest) xapi-idl (re_export rpclib.core) rpclib.json rpclib.xml result)
  (wrapped false)
)

(executable
 (name guard_interfaces_test)
 (modules guard_interfaces_test)
 (libraries
   test_lib
   xapi_idl_guard_privileged
   xapi_idl_guard_varstored
 )
)

(rule
  (alias runtest)
  (package xapi-idl)
  (deps (:exe ./guard_interfaces_test.exe) (source_tree test_data/guard))
  (action (run %{exe}))
)

(test
 (name device_number_test)
 (package xapi-idl)
 (modules device_number_test)
 (libraries
   alcotest
   fmt
   xapi_idl_xen_interface_types
 )
)

(test
 (name test)
 (modes exe)
 (package xapi-idl)
 (modules (:standard \ idl_test_common guard_interfaces_test device_number_test))
 (libraries
   alcotest
   cohttp_posix
   fmt
   result
   rpclib.core
   rpclib.json
   rpclib.markdown
   rpclib.xml
   test_lib
   threads.posix
   xapi-idl
   xapi-idl.cluster
   xapi_idl_rrd
   xapi-idl.memory
   xapi-idl.updates
   xapi-idl.network
   xapi-idl.gpumon
   xapi-idl.storage
   xapi-idl.storage.interface
   xapi-idl.v6
   xapi_idl_xen
   xapi_idl_xen_interface
   xapi-log
 )
 (preprocess (per_module ((pps ppx_deriving_rpc) Task_server_test Updates_test))))

(rule
  (alias runtest)
  (package xapi-idl)
  (deps (:exe ./test.exe) (source_tree test_data/guard))
  (action (run %{exe}))
)
