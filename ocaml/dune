(rule
  (with-stdout-to ctypesdir (run dirname %{lib:ctypes:cstubs_internals.h}))
)

(rule
  (targets xapi.sarif lintcstubs.stdout lintcstubs.stderr)
  (deps
    (:auth (glob_files auth/*.h))
    (:cstubs (glob_files_rec *_stubs.c)))

  ; enable only errors from our analyses
  ; so that the paths in the .sarif will be correct a chdir is needed
  (action
    (progn
      (run rm -f goblint.sarif)
      (run ln -s %{read-lines:ctypesdir} ctypes)
      (with-stdout-to lintcstubs.stdout
      (with-stderr-to lintcstubs.stderr
        (chdir %{project_root}
        (run ocaml/staticanalyzer/lintcstubs.exe -o ocaml/xapi.sarif --disable warn.info
            --disable warn.behavior
            --disable warn.warning --disable warn.unsound --disable warn.imprecise
            --set ana.activated "[\"ocamlcstubs\"]"
            --sarif -I %{ocaml_where} -I ocaml/staticanalyzer/destpatch/gcc_11
            -I ocaml/auth -I ocaml/ctypes
            %{cstubs}))))))
 )
            ; --enable dbg.debug --enable dbg.verbose

(rule
 (alias analyze)
 (deps lintcstubs.stdout)
 (action (diff xapi.stdout.reference %{deps}))
)
